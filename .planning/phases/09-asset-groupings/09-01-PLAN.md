---
phase: 09-asset-groupings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/asset_optimization/simulation/config.py
  - src/asset_optimization/simulation/simulator.py
  - tests/test_simulation.py
autonomous: true

must_haves:
  truths:
    - "User can define asset groups via group_id column in portfolio DataFrame"
    - "User can enable failure propagation where a failed asset increases risk for other group members"
    - "User can configure propagation factor controlling how much risk increases"
    - "Portfolios without group_id column work unchanged (no regressions)"
  artifacts:
    - path: "src/asset_optimization/simulation/config.py"
      provides: "SimulationConfig with enable_propagation and propagation_factor fields"
      contains: "enable_propagation"
    - path: "src/asset_optimization/simulation/simulator.py"
      provides: "Simulator._propagate_failures() method for group-level risk sharing"
      contains: "_propagate_failures"
    - path: "tests/test_simulation.py"
      provides: "Tests for propagation logic and config validation"
      contains: "test_propagat"
  key_links:
    - from: "src/asset_optimization/simulation/simulator.py"
      to: "src/asset_optimization/simulation/config.py"
      via: "self.config.enable_propagation and self.config.propagation_factor"
      pattern: "self\\.config\\.enable_propagation"
    - from: "src/asset_optimization/simulation/simulator.py"
      to: "_propagate_failures"
      via: "called in _simulate_timestep after initial failure sampling"
      pattern: "_propagate_failures"
---

<objective>
Implement failure propagation within asset groups in the simulation engine.

Purpose: When assets share a group (e.g., pipes in the same trench), failure of one asset should increase the failure risk of other group members. This models real-world correlated risk in infrastructure clusters.

Output: Extended SimulationConfig with propagation settings, Simulator._propagate_failures() method, and comprehensive tests.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-asset-groupings/09-RESEARCH.md
@src/asset_optimization/simulation/config.py
@src/asset_optimization/simulation/simulator.py
@tests/test_simulation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SimulationConfig with propagation settings</name>
  <files>src/asset_optimization/simulation/config.py</files>
  <action>
Add two new fields to SimulationConfig dataclass:

1. `enable_propagation: bool = False` -- Whether to enable failure propagation within groups. Default False preserves backward compatibility.
2. `propagation_factor: float = 0.5` -- Multiplier for risk increase when a group member fails. Formula: P_new = min(P_old * (1 + propagation_factor), 1.0). Must be >= 0.

Add validation in `__post_init__`:
- `propagation_factor` must be non-negative (raise ValueError if < 0)
- Validation only fires when `enable_propagation` is True OR always validate (simpler -- always validate since the field exists)

Update the docstring to document both new parameters with NumPy-style formatting, including the formula and note that `propagation_factor` is only used when `enable_propagation=True`.

Do NOT change any existing fields or validation logic.
  </action>
  <verify>
Run `uv run pytest tests/test_simulation.py -x -q` -- existing tests must still pass (backward compatibility).
Verify: `from asset_optimization import SimulationConfig; c = SimulationConfig(n_years=10); assert c.enable_propagation == False; assert c.propagation_factor == 0.5`
Verify: `SimulationConfig(n_years=10, propagation_factor=-0.1)` raises ValueError.
  </verify>
  <done>SimulationConfig accepts enable_propagation and propagation_factor fields with validation. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Implement _propagate_failures in Simulator and add tests</name>
  <files>
    src/asset_optimization/simulation/simulator.py
    tests/test_simulation.py
  </files>
  <action>
**In simulator.py:**

Add a `_propagate_failures` method to the Simulator class:

```python
def _propagate_failures(
    self,
    state: pd.DataFrame,
    initial_failures: pd.Series,
    baseline_probs: np.ndarray,
) -> pd.Series:
```

Logic:
1. If `group_id` not in state.columns, return initial_failures unchanged.
2. Copy initial_failures to final_failures.
3. Find groups with at least one failure: `state.loc[initial_failures, 'group_id'].dropna().unique()`.
4. For each affected group:
   a. Find group members that did NOT fail initially: `group_mask & ~initial_failures`.
   b. Increase their probability: `P_new = min(P_old * (1 + self.config.propagation_factor), 1.0)` using np.minimum.
   c. Re-sample these assets using `self.rng.random()` against the new probabilities.
   d. Update final_failures for these indices.
5. Return final_failures.

Key: Single-pass propagation only (no recursion). Use `self.rng` for re-sampling to maintain reproducibility.

**In _simulate_timestep:**

After line `failures_mask = pd.Series(random_draws < probs, index=state.index)` and BEFORE `state.loc[failures_mask, "age_at_failure"]`, add:

```python
# Propagate failures within groups if enabled
if self.config.enable_propagation and 'group_id' in state.columns:
    failures_mask = self._propagate_failures(state, failures_mask, probs)
```

**In tests/test_simulation.py, add these tests:**

1. `test_propagation_disabled_by_default` -- portfolio with group_id, default config, verify propagation does not happen (same results as without group_id).

2. `test_propagation_increases_failures` -- Create a portfolio with 2 groups of 3 assets each. Set propagation_factor=10.0 (very high, nearly guarantees propagation). Use a seed where at least one asset fails. Verify that the group with the initial failure has MORE total failures than without propagation (run same seed with enable_propagation=False as baseline).

3. `test_propagation_no_group_id_column` -- portfolio without group_id, enable_propagation=True, verify simulation runs without error and produces same results as enable_propagation=False.

4. `test_propagation_null_group_ids` -- portfolio with some null group_ids (ungrouped assets). Verify null-group assets are unaffected by propagation.

5. `test_propagation_factor_validation` -- SimulationConfig(n_years=10, propagation_factor=-0.5) raises ValueError.

6. `test_propagation_deterministic_with_seed` -- Same portfolio + config + seed produces identical results when run twice.

Use WeibullModel with parameters that give meaningful failure probabilities for the test ages. Follow existing test patterns in the file.
  </action>
  <verify>
Run `uv run pytest tests/test_simulation.py -x -v` -- all tests pass including new propagation tests.
Run `uv run pytest -x -q` -- full test suite passes (no regressions).
Run `make lint` -- passes.
  </verify>
  <done>
Simulator._propagate_failures() correctly increases failure risk for group members when enabled. Six new tests verify: default-off behavior, increased failures with propagation, graceful handling of missing/null group_id, config validation, and deterministic reproducibility.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_simulation.py -v` -- all simulation tests pass
2. `uv run pytest -x -q` -- full test suite passes
3. `make lint` -- no lint errors
4. SimulationConfig backward compatible (existing code unaffected)
5. Propagation only activates when both enable_propagation=True AND group_id column exists
</verification>

<success_criteria>
- SimulationConfig has enable_propagation (default False) and propagation_factor (default 0.5) fields
- Simulator._propagate_failures() implements single-pass group failure propagation
- _simulate_timestep calls _propagate_failures when conditions met
- 6+ new tests covering propagation logic, edge cases, and validation
- All existing tests pass without modification
- make lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-asset-groupings/09-01-SUMMARY.md`
</output>
