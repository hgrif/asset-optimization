---
phase: 09-asset-groupings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/asset_optimization/models/group_propagation.py
  - src/asset_optimization/models/__init__.py
  - src/asset_optimization/__init__.py
  - tests/test_group_propagation.py
  - tests/test_public_api.py
autonomous: true

must_haves:
  truths:
    - "User can wrap a RiskModel to enable group failure propagation"
    - "Propagation factor is configurable and validated as non-negative"
    - "Ungrouped assets (missing or null group_id) are unchanged"
    - "Propagation is deterministic (no randomness in prediction step)"
  artifacts:
    - path: "src/asset_optimization/models/group_propagation.py"
      provides: "GroupPropagationRiskModel wrapper"
      contains: "GroupPropagationRiskModel"
    - path: "tests/test_group_propagation.py"
      provides: "Group propagation unit tests"
      contains: "test_group_propagation"
  key_links:
    - from: "src/asset_optimization/models/group_propagation.py"
      to: "src/asset_optimization/protocols.py"
      via: "RiskModel protocol compliance"
      pattern: "RiskModel"
    - from: "src/asset_optimization/models/group_propagation.py"
      to: "src/asset_optimization/models/base.py"
      via: "predict_distribution schema (failure_prob)"
      pattern: "failure_prob"
---

<objective>
Implement failure propagation within asset groups by wrapping existing RiskModel outputs.

Purpose: Increase failure probabilities for assets that share a group, without adding a simulation loop.

Output: GroupPropagationRiskModel wrapper with deterministic propagation, public exports, and tests.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-asset-groupings/09-RESEARCH.md
@src/asset_optimization/models/base.py
@src/asset_optimization/protocols.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GroupPropagationRiskModel wrapper</name>
  <files>
    src/asset_optimization/models/group_propagation.py
  </files>
  <action>
Create `GroupPropagationRiskModel` that wraps a base RiskModel and adjusts failure probabilities for grouped assets.

**Class signature:**
```python
class GroupPropagationRiskModel:
    def __init__(
        self,
        base_model: RiskModel,
        propagation_factor: float = 0.5,
        group_column: str = "group_id",
        min_group_size: int = 2,
    ):
        ...
```

**Validation:**
- `base_model` implements RiskModel (use `isinstance(base_model, RiskModel)` since protocol is runtime_checkable)
- `propagation_factor` must be finite and >= 0
- `group_column` must be a non-empty string
- `min_group_size` must be an int >= 2

**Methods:**
- `fit(...)` delegates to `base_model.fit(...)` and returns `self`
- `predict_distribution(...)`:
  1. Call `base_model.predict_distribution(...)` to get baseline DataFrame
  2. If `group_column` not in assets or `propagation_factor == 0`, return baseline
  3. Join `group_id` onto baseline via `asset_id`
  4. Compute group sizes from assets; only apply propagation to groups with size >= `min_group_size`
  5. For each `(scenario_id, horizon_step, group_id)`:
     - `P_group = 1 - Î (1 - P_i)`
     - `P_i_new = min(P_i * (1 + propagation_factor * P_group), 1.0)`
  6. Drop helper columns and return DataFrame with same columns/order as baseline
- `describe()` returns `base_model.describe()` plus propagation metadata

Keep the implementation vectorized using pandas groupby and numpy operations.
  </action>
  <verify>
Run `uv run pytest tests/test_group_propagation.py -x -v`.
Verify `propagation_factor=0` leaves predictions unchanged.
Verify grouped assets get higher `failure_prob` when factor > 0.
  </verify>
  <done>GroupPropagationRiskModel wraps any RiskModel and deterministically increases failure_prob for grouped assets.</done>
</task>

<task type="auto">
  <name>Task 2: Export GroupPropagationRiskModel</name>
  <files>
    src/asset_optimization/models/__init__.py
    src/asset_optimization/__init__.py
    tests/test_public_api.py
  </files>
  <action>
- Export `GroupPropagationRiskModel` from `src/asset_optimization/models/__init__.py`.
- Export `GroupPropagationRiskModel` from `src/asset_optimization/__init__.py` and include in `__all__`.
- Add a public API test assertion in `tests/test_public_api.py` (matching the existing export test style).
  </action>
  <verify>
Run `uv run pytest tests/test_public_api.py -x -v`.
  </verify>
  <done>GroupPropagationRiskModel is part of the public API.</done>
</task>

<task type="auto">
  <name>Task 3: Add propagation tests</name>
  <files>
    tests/test_group_propagation.py
  </files>
  <action>
Create tests using a DummyRiskModel that returns deterministic `failure_prob` from assets.

Test cases:
1. `test_propagation_no_group_column` -- assets without group_id return unchanged predictions.
2. `test_propagation_increases_grouped_assets` -- grouped assets increase when factor > 0; ungrouped unchanged.
3. `test_propagation_skips_singletons` -- group size 1 does not change.
4. `test_propagation_factor_validation` -- negative factor raises ValueError.
5. `test_describe_includes_propagation_metadata` -- describe() includes propagation settings.

Use a short PlanningHorizon and a baseline failure_prob column in assets for clarity.
  </action>
  <verify>
Run `uv run pytest tests/test_group_propagation.py -x -v`.
  </verify>
  <done>Propagation tests cover grouped behavior, singleton handling, validation, and metadata.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_group_propagation.py -v`
2. `uv run pytest -x -q`
3. `make lint`
4. `make docs`
5. Public API exports include GroupPropagationRiskModel
</verification>

<success_criteria>
- GroupPropagationRiskModel exists and wraps any RiskModel
- Propagation increases failure_prob for grouped assets only
- Ungrouped/singleton assets are unchanged
- Public API exports updated
- All tests and quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-asset-groupings/09-01-SUMMARY.md`
</output>
