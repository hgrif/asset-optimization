---
phase: 09-asset-groupings
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - notebooks/06_asset_groupings.py
autonomous: true

must_haves:
  truths:
    - "Documentation notebook demonstrates defining asset groups via group_id column"
    - "Documentation notebook demonstrates failure propagation using GroupPropagationRiskModel"
    - "Documentation notebook demonstrates group coherence constraint in optimizer"
    - "Notebook converts to .ipynb via jupytext and renders correctly"
  artifacts:
    - path: "notebooks/06_asset_groupings.py"
      provides: "Jupytext percent-format notebook demonstrating asset groupings"
      contains: "group_id"
  key_links:
    - from: "notebooks/06_asset_groupings.py"
      to: "src/asset_optimization/models/group_propagation.py"
      via: "GroupPropagationRiskModel(...)"
      pattern: "GroupPropagationRiskModel"
    - from: "notebooks/06_asset_groupings.py"
      to: "src/asset_optimization/constraints.py"
      via: "ConstraintSet().add_group_coherence()"
      pattern: "add_group_coherence"
---

<objective>
Create a documentation notebook demonstrating asset groupings with propagation and group-level optimization constraints.

Purpose: Show users how to define groups, adjust risk via GroupPropagationRiskModel, and enforce all-or-nothing selection via optimizer constraints.

Output: notebooks/06_asset_groupings.py (jupytext percent-format) that converts to .ipynb.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-asset-groupings/09-RESEARCH.md
@.planning/phases/09-asset-groupings/09-01-SUMMARY.md
@.planning/phases/09-asset-groupings/09-02-SUMMARY.md
@notebooks/05_roads_domain.py
@notebooks/TEMPLATE.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create asset groupings documentation notebook</name>
  <files>notebooks/06_asset_groupings.py</files>
  <action>
Create `notebooks/06_asset_groupings.py` in jupytext percent-format following the pattern from existing notebooks (especially 05_roads_domain.py and TEMPLATE.py).

**Structure:**

1. **Header cell** (markdown): Title "Asset Groupings" with a brief description.

2. **Setup cell**: Import:
   - `numpy`, `pandas`, `matplotlib.pyplot as plt`
   - From asset_optimization: `WeibullModel`, `GroupPropagationRiskModel`, `PlanningHorizon`, `ConstraintSet`, `ObjectiveBuilder`, `Optimizer`, `Planner`, `DataFrameRepository`, `RuleBasedEffectModel`, `BasicNetworkSimulator`

3. **Section: Defining Asset Groups** (markdown + code):
   - Explain `group_id` as optional column.
   - Create ~12 pipe assets with 3-4 groups (e.g., trench_A/B/C) plus 2-3 ungrouped assets (group_id=None).
   - Use realistic install_date spans and asset_type values.
   - Compute `age` from install_date.
   - Display the portfolio grouped by group_id.

4. **Section: Failure Propagation** (markdown + code):
   - Explain propagation concept and formula.
   - Create baseline `WeibullModel` and `GroupPropagationRiskModel` wrapper.
   - Use a `PlanningHorizon` (10-year window).
   - Call `predict_distribution()` for baseline and propagated models.
   - Aggregate total expected failures per year and show a comparison table.
   - Plot a bar chart comparing baseline vs propagated failures per year.

5. **Section: Configuring Propagation Factor** (markdown + code):
   - Run predictions for factors `[0.0, 0.3, 0.5, 1.0]`.
   - Plot total expected failures vs propagation_factor.

6. **Section: Group Coherence Constraints** (markdown + code):
   - Build a candidates DataFrame with `asset_id`, `group_id`, `direct_cost`, `expected_benefit`.
   - Show optimization WITHOUT group coherence.
   - Show optimization WITH group coherence via `ConstraintSet().add_budget_limit(X).add_group_coherence()`.
   - Print selected assets for both runs.

7. **Section: Putting It Together** (markdown + code):
   - Build a Planner using `DataFrameRepository`, `GroupPropagationRiskModel(WeibullModel(...))`, `RuleBasedEffectModel`, `BasicNetworkSimulator`, `Optimizer`.
   - Call `planner.fit()` and `planner.propose_actions(...)`.
   - Solve with group coherence and show a small summary of selections.

Conventions:
- Use `# %%` for code cells and `# %% [markdown]` for markdown cells.
- Include the standard jupytext header block.
- Use `np.random.seed(...)` for reproducibility of synthetic data.
- Avoid `set_sdk_theme()` (not available in repo).
- Keep code cells short with clear markdown explanation.

Do NOT execute the notebook here; only create the .py source file.
  </action>
  <verify>
Run `make docs-sync` to generate .ipynb from the .py file.
Run `make lint`.
Verify file exists: `ls notebooks/06_asset_groupings.py`.
  </verify>
  <done>
notebooks/06_asset_groupings.py exists as a complete jupytext percent-format notebook demonstrating: (1) group_id usage, (2) propagation via GroupPropagationRiskModel, (3) propagation factor sensitivity, (4) group coherence constraints, (5) end-to-end Planner workflow. Converts to .ipynb via make docs-sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute notebook and verify output</name>
  <files>notebooks/06_asset_groupings.py</files>
  <action>
Run `make docs` to execute the notebook source and sync to .ipynb.

If execution fails:
- Identify the failing cell from the error output.
- Fix the issue in notebooks/06_asset_groupings.py.
- Re-run `make docs` until it succeeds.

After successful execution, verify:
- notebooks/06_asset_groupings.ipynb exists and has output cells.
- The notebook demonstrates all key features without errors.

Run `make lint` and `make test` as final quality gates.
  </action>
  <verify>
Run `make docs`.
Run `make test`.
Run `make lint`.
Verify: `ls notebooks/06_asset_groupings.ipynb`.
  </verify>
  <done>
Notebook executes successfully, produces comparison charts and tables, and .ipynb is generated. All quality gates (lint, test, docs) pass.
  </done>
</task>

</tasks>

<verification>
1. `make docs`
2. `make test`
3. `make lint`
4. notebooks/06_asset_groupings.py exists with correct jupytext format
5. notebooks/06_asset_groupings.ipynb exists with output cells
6. Notebook covers GRUP requirements and DOCS-03
</verification>

<success_criteria>
- notebooks/06_asset_groupings.py is a complete jupytext percent-format notebook
- Demonstrates group_id definition, propagation, propagation factor config, and group coherence
- Includes comparison visualizations
- Executes without errors via make docs
- All quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-asset-groupings/09-03-SUMMARY.md`
</output>
