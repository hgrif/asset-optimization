---
phase: 09-asset-groupings
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - notebooks/06_asset_groupings.py
autonomous: true

must_haves:
  truths:
    - "Documentation notebook demonstrates defining asset groups via group_id column"
    - "Documentation notebook demonstrates failure propagation with before/after comparison"
    - "Documentation notebook demonstrates group coherence constraint in optimizer"
    - "Notebook converts to .ipynb via jupytext and renders correctly"
  artifacts:
    - path: "notebooks/06_asset_groupings.py"
      provides: "Jupytext percent-format notebook demonstrating asset groupings"
      contains: "group_id"
  key_links:
    - from: "notebooks/06_asset_groupings.py"
      to: "src/asset_optimization/simulation/config.py"
      via: "SimulationConfig(enable_propagation=True, propagation_factor=...)"
      pattern: "enable_propagation"
    - from: "notebooks/06_asset_groupings.py"
      to: "src/asset_optimization/constraints.py"
      via: "ConstraintSet().add_group_coherence()"
      pattern: "add_group_coherence"
---

<objective>
Create a documentation notebook demonstrating asset groupings with failure propagation and group-level optimization constraints.

Purpose: Show users how to define asset groups, enable failure propagation, configure propagation factor, and use group coherence constraints in optimization. This is the primary learning resource for the groupings feature.

Output: notebooks/06_asset_groupings.py (jupytext percent-format) that converts to .ipynb.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-asset-groupings/09-RESEARCH.md
@.planning/phases/09-asset-groupings/09-01-SUMMARY.md
@.planning/phases/09-asset-groupings/09-02-SUMMARY.md
@notebooks/05_roads_domain.py
@notebooks/TEMPLATE.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create asset groupings documentation notebook</name>
  <files>notebooks/06_asset_groupings.py</files>
  <action>
Create `notebooks/06_asset_groupings.py` in jupytext percent-format following the pattern from existing notebooks (especially 05_roads_domain.py and TEMPLATE.py).

**Structure:**

1. **Header cell** (markdown): Title "Asset Groupings", brief description of what groupings enable (correlated risk, coordinated interventions).

2. **Setup cell**: Import asset_optimization classes (WeibullModel, Simulator, SimulationConfig, Optimizer, ObjectiveBuilder, ConstraintSet), pandas, numpy, matplotlib.

3. **Section: Defining Asset Groups** (markdown + code):
   - Explain group_id as optional column in portfolio DataFrame.
   - Create a sample portfolio of ~12 pipe assets organized into 3-4 groups (e.g., 'trench_A', 'trench_B', 'trench_C') plus 2-3 ungrouped assets (group_id=None).
   - Use realistic pipe data: install_date spanning 2000-2020, asset_type PVC/Cast Iron, asset_id like 'pipe_01' through 'pipe_12'.
   - Display the portfolio grouped by group_id to show the structure.

4. **Section: Failure Propagation** (markdown + code):
   - Explain the propagation concept: when one asset in a group fails, it increases failure risk for other group members.
   - Explain the formula: P_new = min(P_old * (1 + propagation_factor), 1.0).
   - Run two simulations with the SAME seed:
     a. Baseline: enable_propagation=False (10-year simulation)
     b. With propagation: enable_propagation=True, propagation_factor=0.5
   - Compare results: show total failures per simulation, print a comparison table.
   - Create a matplotlib bar chart comparing failures per year between the two scenarios.

5. **Section: Configuring Propagation Factor** (markdown + code):
   - Explain that propagation_factor controls severity of risk sharing.
   - Run 3-4 simulations with different propagation_factors (0.0, 0.3, 0.5, 1.0).
   - Plot total failures vs propagation_factor to show the relationship.

6. **Section: Group Coherence Constraints** (markdown + code):
   - Explain group coherence: when optimizing, either maintain ALL assets in a group or NONE.
   - Create a candidates DataFrame with grouped assets (include group_id, asset_id, direct_cost, expected_benefit columns).
   - Show optimization WITHOUT group coherence -- assets selected individually.
   - Show optimization WITH group coherence via ConstraintSet().add_budget_limit(X).add_group_coherence() -- entire groups selected together.
   - Print both results showing selected assets and highlight the difference.

7. **Section: Putting It Together** (markdown + code):
   - Combine propagation simulation with group-constrained optimization in a realistic workflow.
   - Brief summary of what was covered.

Follow these conventions from existing notebooks:
- Use `# %%` for code cells, `# %% [markdown]` for markdown cells.
- Include jupytext header with format_name: percent, format_version: '1.3', kernelspec info.
- Use `set_sdk_theme()` for plot styling if available.
- Keep code cells concise with clear explanatory markdown between them.
- Use random_seed for reproducibility in all simulations.

Do NOT execute the notebook -- just create the .py source file.
  </action>
  <verify>
Run `make docs-sync` to generate .ipynb from the .py file -- must succeed without errors.
Run `make lint` -- passes.
Verify file exists: `ls notebooks/06_asset_groupings.py`
Verify jupytext header is correct: file starts with `# ---` jupytext block.
  </verify>
  <done>
notebooks/06_asset_groupings.py exists as a complete jupytext percent-format notebook demonstrating: (1) defining groups via group_id, (2) failure propagation with before/after comparison, (3) propagation factor sensitivity, (4) group coherence constraints, (5) combined workflow. Converts to .ipynb via make docs-sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute notebook and verify output</name>
  <files>notebooks/06_asset_groupings.py</files>
  <action>
Run `make docs` to execute the notebook source and sync to .ipynb.

If execution fails:
- Read the error output to identify which cell failed.
- Fix the issue in notebooks/06_asset_groupings.py (common issues: import errors, wrong API signatures, missing columns in DataFrames).
- Re-run `make docs` until it succeeds.

After successful execution, verify:
- notebooks/06_asset_groupings.ipynb exists and has output cells.
- The notebook demonstrates all key features without errors.

Run `make lint` and `make test` as final quality gates.
  </action>
  <verify>
Run `make docs` -- succeeds (notebook executes and syncs).
Run `make test` -- full test suite passes.
Run `make lint` -- passes.
Verify: `ls notebooks/06_asset_groupings.ipynb` -- file exists.
  </verify>
  <done>
Notebook executes successfully, produces comparison charts and tables, and .ipynb is generated. All quality gates (lint, test, docs) pass.
  </done>
</task>

</tasks>

<verification>
1. `make docs` -- notebook executes and syncs without errors
2. `make test` -- full test suite passes
3. `make lint` -- no lint errors
4. notebooks/06_asset_groupings.py exists with correct jupytext format
5. notebooks/06_asset_groupings.ipynb exists with output cells
6. Notebook covers all 4 GRUP requirements and DOCS-03
</verification>

<success_criteria>
- notebooks/06_asset_groupings.py is a complete jupytext percent-format notebook
- Demonstrates group_id column definition, failure propagation, propagation factor config, and group coherence constraints
- Includes comparison visualizations (with/without propagation)
- Executes without errors via make docs
- All quality gates pass (make lint, make test, make docs)
</success_criteria>

<output>
After completion, create `.planning/phases/09-asset-groupings/09-03-SUMMARY.md`
</output>
