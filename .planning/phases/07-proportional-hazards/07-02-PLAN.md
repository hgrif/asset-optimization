---
phase: 07-proportional-hazards
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/asset_optimization/models/proportional_hazards.py
  - src/asset_optimization/simulation/simulator.py
  - src/asset_optimization/__init__.py
  - tests/test_proportional_hazards.py
autonomous: true

must_haves:
  truths:
    - "ProportionalHazardsModel works with Simulator.run()"
    - "Simulation correctly applies covariate-scaled conditional probabilities"
    - "Existing WeibullModel simulations continue to work unchanged"
  artifacts:
    - path: "src/asset_optimization/models/proportional_hazards.py"
      provides: "calculate_conditional_probability method"
      contains: "def calculate_conditional_probability"
    - path: "src/asset_optimization/simulation/simulator.py"
      provides: "Duck-typed hook for model conditional probability"
      contains: "hasattr.*calculate_conditional_probability"
  key_links:
    - from: "src/asset_optimization/simulation/simulator.py"
      to: "src/asset_optimization/models/proportional_hazards.py"
      via: "duck-typed calculate_conditional_probability call"
      pattern: "model\\.calculate_conditional_probability"
---

<objective>
Integrate ProportionalHazardsModel with Simulator so that simulations correctly use covariate-scaled conditional failure probabilities.

Purpose: Enable HAZD-04 (ProportionalHazardsModel implements DeteriorationModel interface and works with Simulator).

Output: Simulator correctly runs with ProportionalHazardsModel, applying covariate effects to failure probabilities during simulation.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-proportional-hazards/07-RESEARCH.md
@.planning/phases/07-proportional-hazards/07-01-SUMMARY.md

# Key source files
@src/asset_optimization/models/proportional_hazards.py
@src/asset_optimization/simulation/simulator.py
@tests/test_simulation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calculate_conditional_probability to ProportionalHazardsModel</name>
  <files>src/asset_optimization/models/proportional_hazards.py</files>
  <action>
Add `calculate_conditional_probability(state: pd.DataFrame) -> np.ndarray` method to ProportionalHazardsModel:

```python
def calculate_conditional_probability(self, state: pd.DataFrame) -> np.ndarray:
    """Calculate P(fail in [t,t+1) | survived to t) with covariate scaling.

    For Weibull-PH: S(t|x) = S0(t)^r where r = exp(beta'x)
    Conditional probability = 1 - S(t+1|x) / S(t|x)
                           = 1 - [S0(t+1)/S0(t)]^r

    Parameters
    ----------
    state : pd.DataFrame
        Current asset state with 'age' column and material/covariate columns.

    Returns
    -------
    np.ndarray
        Conditional failure probabilities for each asset.
    """
```

Implementation steps:
1. Compute risk_score for each row using self._risk_score(state)
2. Get Weibull params via self.params (delegated to baseline)
3. For each asset_type group:
   - Get shape, scale from self.params[asset_type]
   - Compute S0(t) = weibull_min.sf(ages, c=shape, scale=scale)
   - Compute S0(t+1) = weibull_min.sf(ages + 1, c=shape, scale=scale)
   - Compute survival_ratio = S0(t+1) / S0(t) (handle S0(t)=0 case)
   - Apply risk_score: cond_prob = 1 - survival_ratio^r
   - Clip to [0, 1]
4. Return array of conditional probabilities

Import weibull_min from scipy.stats at top of file.
  </action>
  <verify>
```bash
cd /Users/henkgriffioen/code/asset-optimization
python -c "
from asset_optimization.models import ProportionalHazardsModel, WeibullModel
import pandas as pd

baseline = WeibullModel({'PVC': (2.5, 50)})
ph = ProportionalHazardsModel(baseline, covariates=['diameter_mm'], coefficients={'diameter_mm': 0.01})

state = pd.DataFrame({'material': ['PVC'], 'age': [20], 'diameter_mm': [150]})
probs = ph.calculate_conditional_probability(state)
print(f'Conditional probability: {probs[0]:.4f}')
assert 0 < probs[0] < 1, 'Valid probability'
print('calculate_conditional_probability works')
"
```
  </verify>
  <done>
ProportionalHazardsModel.calculate_conditional_probability() method exists and returns valid conditional probabilities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Simulator to use duck-typed hook</name>
  <files>
    src/asset_optimization/simulation/simulator.py
    src/asset_optimization/__init__.py
  </files>
  <action>
Modify `Simulator._calculate_conditional_probability()` method to check for model hook:

At the START of the method (before the existing Weibull-specific code), add:

```python
def _calculate_conditional_probability(self, state: pd.DataFrame) -> np.ndarray:
    """Calculate conditional failure probability for each asset.
    ...existing docstring...
    """
    # Duck-typed hook: if model provides calculate_conditional_probability, use it
    if hasattr(self.model, 'calculate_conditional_probability'):
        return self.model.calculate_conditional_probability(state)

    # Fallback: existing Weibull-specific implementation
    probs = np.zeros(len(state))
    ... rest of existing code unchanged ...
```

This maintains backward compatibility:
- WeibullModel: no calculate_conditional_probability method -> uses existing Weibull-specific path
- ProportionalHazardsModel: has the method -> uses model's covariate-aware calculation

Update `src/asset_optimization/__init__.py`:
- Add ProportionalHazardsModel to imports from .models
- Add ProportionalHazardsModel to __all__ list
  </action>
  <verify>
```bash
cd /Users/henkgriffioen/code/asset-optimization

# Verify WeibullModel still works (no regression)
pytest tests/test_simulation.py -v -k "test_" --tb=short

# Verify import from main package
python -c "from asset_optimization import ProportionalHazardsModel; print('Import OK')"
```
  </verify>
  <done>
Simulator uses duck-typed hook for conditional probability. Existing WeibullModel tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Simulator integration tests</name>
  <files>tests/test_proportional_hazards.py</files>
  <action>
Add new test class `TestProportionalHazardsSimulatorIntegration` to tests/test_proportional_hazards.py:

**Tests to add:**

```python
class TestProportionalHazardsSimulatorIntegration:
    """Test ProportionalHazardsModel integration with Simulator (HAZD-04)."""

    @pytest.fixture
    def simulation_config(self):
        """Short simulation for testing."""
        from asset_optimization import SimulationConfig
        return SimulationConfig(n_years=5, random_seed=42)

    @pytest.fixture
    def portfolio_with_covariates(self):
        """Portfolio DataFrame with covariate columns."""
        from asset_optimization.portfolio import validate_portfolio
        df = pd.DataFrame({
            'asset_id': ['P1', 'P2', 'P3', 'P4'],
            'asset_type': ['pipe'] * 4,
            'material': ['PVC'] * 4,
            'install_date': pd.to_datetime(['2000-01-01'] * 4),
            'diameter_mm': [100, 150, 200, 250],  # Increasing diameter
            'length_m': [50.0] * 4,
        })
        return validate_portfolio(df)

    def test_simulator_runs_with_ph_model(self, simulation_config, portfolio_with_covariates):
        """Simulator.run() completes without error using ProportionalHazardsModel."""
        from asset_optimization import Simulator, WeibullModel
        from asset_optimization.models import ProportionalHazardsModel

        baseline = WeibullModel({'PVC': (2.5, 50)})
        ph = ProportionalHazardsModel(
            baseline,
            covariates=['diameter_mm'],
            coefficients={'diameter_mm': 0.005}
        )

        sim = Simulator(ph, simulation_config)
        result = sim.run(portfolio_with_covariates)

        assert result is not None
        assert result.total_cost >= 0
        assert len(result.yearly_summaries) == 5

    def test_covariate_affects_failure_rate_in_simulation(self, simulation_config, portfolio_with_covariates):
        """Higher covariate values lead to more failures over time."""
        from asset_optimization import Simulator, WeibullModel
        from asset_optimization.models import ProportionalHazardsModel

        baseline = WeibullModel({'PVC': (2.5, 50)})

        # Run with large positive coefficient (diameter increases risk)
        ph_high = ProportionalHazardsModel(
            baseline,
            covariates=['diameter_mm'],
            coefficients={'diameter_mm': 0.02}  # Strong effect
        )
        sim_high = Simulator(ph_high, simulation_config)
        result_high = sim_high.run(portfolio_with_covariates)

        # Run with zero coefficient (baseline only)
        ph_baseline = ProportionalHazardsModel(
            baseline,
            covariates=['diameter_mm'],
            coefficients={'diameter_mm': 0.0}  # No effect
        )
        sim_baseline = Simulator(ph_baseline, simulation_config)
        result_baseline = sim_baseline.run(portfolio_with_covariates)

        # With positive coefficient, expect more failures (higher failure cost)
        # Note: stochastic, but with seed=42 and strong coefficient, should be consistent
        assert result_high.failure_cost >= result_baseline.failure_cost * 0.5  # At least not way lower

    def test_simulation_backward_compat_missing_covariate(self, simulation_config):
        """Simulation works when portfolio lacks covariate columns."""
        from asset_optimization import Simulator, WeibullModel
        from asset_optimization.models import ProportionalHazardsModel
        from asset_optimization.portfolio import validate_portfolio

        # Portfolio WITHOUT diameter_mm column
        df = pd.DataFrame({
            'asset_id': ['P1', 'P2'],
            'asset_type': ['pipe'] * 2,
            'material': ['PVC'] * 2,
            'install_date': pd.to_datetime(['2000-01-01'] * 2),
            'length_m': [50.0] * 2,
        })
        portfolio = validate_portfolio(df)

        baseline = WeibullModel({'PVC': (2.5, 50)})
        ph = ProportionalHazardsModel(
            baseline,
            covariates=['diameter_mm'],  # Column not in portfolio
            coefficients={'diameter_mm': 0.01}
        )

        sim = Simulator(ph, simulation_config)
        result = sim.run(portfolio)  # Should not raise

        assert result is not None
        assert result.total_cost >= 0
```

Also add test for `calculate_conditional_probability` directly:

```python
class TestProportionalHazardsConditionalProbability:
    """Test calculate_conditional_probability method."""

    def test_returns_array_same_length_as_input(self):
        baseline = WeibullModel({'PVC': (2.5, 50), 'Cast Iron': (3.0, 40)})
        ph = ProportionalHazardsModel(baseline, covariates=[], coefficients={})

        state = pd.DataFrame({
            'material': ['PVC', 'Cast Iron', 'PVC'],
            'age': [10, 20, 30]
        })

        probs = ph.calculate_conditional_probability(state)
        assert len(probs) == 3

    def test_probabilities_in_valid_range(self):
        baseline = WeibullModel({'PVC': (2.5, 50)})
        ph = ProportionalHazardsModel(baseline, covariates=['x'], coefficients={'x': 0.1})

        state = pd.DataFrame({
            'material': ['PVC'] * 5,
            'age': [10, 20, 30, 40, 50],
            'x': [1.0, 2.0, 3.0, 4.0, 5.0]
        })

        probs = ph.calculate_conditional_probability(state)
        assert all(0 <= p <= 1 for p in probs)

    def test_higher_risk_score_increases_conditional_probability(self):
        baseline = WeibullModel({'PVC': (2.5, 50)})
        ph = ProportionalHazardsModel(baseline, covariates=['x'], coefficients={'x': 0.5})

        # Same age, different covariate values
        state = pd.DataFrame({
            'material': ['PVC', 'PVC'],
            'age': [25, 25],
            'x': [0.0, 2.0]  # Second has higher risk
        })

        probs = ph.calculate_conditional_probability(state)
        assert probs[1] > probs[0], "Higher covariate should increase conditional probability"
```
  </action>
  <verify>
```bash
cd /Users/henkgriffioen/code/asset-optimization
pytest tests/test_proportional_hazards.py -v -k "Integration or ConditionalProbability"
```
  </verify>
  <done>
Simulator integration tests pass. ProportionalHazardsModel works correctly with Simulator.run().
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/henkgriffioen/code/asset-optimization

# All PH tests pass
pytest tests/test_proportional_hazards.py -v

# Existing simulation tests still pass (no regression)
pytest tests/test_simulation.py -v

# Full test suite passes
pytest tests/ -v --tb=short

# End-to-end smoke test
python -c "
from asset_optimization import Simulator, SimulationConfig, WeibullModel
from asset_optimization.models import ProportionalHazardsModel
from asset_optimization.portfolio import validate_portfolio
import pandas as pd

# Create portfolio with covariates
df = pd.DataFrame({
    'asset_id': ['P1', 'P2', 'P3'],
    'asset_type': ['pipe'] * 3,
    'material': ['PVC'] * 3,
    'install_date': pd.to_datetime(['2000-01-01'] * 3),
    'diameter_mm': [100, 200, 300],
    'length_m': [50.0] * 3,
})
portfolio = validate_portfolio(df)

# Create PH model
baseline = WeibullModel({'PVC': (2.5, 50)})
ph = ProportionalHazardsModel(baseline, covariates=['diameter_mm'], coefficients={'diameter_mm': 0.01})

# Run simulation
config = SimulationConfig(n_years=10, random_seed=42)
sim = Simulator(ph, config)
result = sim.run(portfolio)

print(f'Total cost: {result.total_cost:,.0f}')
print(f'Total failures: {result.total_failures}')
print('End-to-end test passed!')
"
```
</verification>

<success_criteria>
- ProportionalHazardsModel has calculate_conditional_probability() method
- Simulator._calculate_conditional_probability() checks for model hook first
- Existing WeibullModel simulations work unchanged (backward compatible)
- Simulator.run() works with ProportionalHazardsModel
- Covariate effects are correctly applied during simulation
- All tests pass including simulation integration tests
- ProportionalHazardsModel importable from main package
</success_criteria>

<output>
After completion, create `.planning/phases/07-proportional-hazards/07-02-SUMMARY.md`
</output>
