---
phase: 07-proportional-hazards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/asset_optimization/models/proportional_hazards.py
  - src/asset_optimization/models/__init__.py
  - tests/test_proportional_hazards.py
autonomous: true

must_haves:
  truths:
    - "User can create ProportionalHazardsModel with any DeteriorationModel as baseline"
    - "User can specify covariates and coefficients at construction"
    - "transform() returns scaled failure_rate and failure_probability"
    - "Missing covariate columns fall back to baseline-only (risk_score=1.0)"
    - "NaN values in covariates fall back to baseline-only for those rows"
  artifacts:
    - path: "src/asset_optimization/models/proportional_hazards.py"
      provides: "ProportionalHazardsModel class"
      exports: ["ProportionalHazardsModel"]
      min_lines: 100
    - path: "tests/test_proportional_hazards.py"
      provides: "Test coverage for ProportionalHazardsModel"
      min_lines: 150
  key_links:
    - from: "src/asset_optimization/models/proportional_hazards.py"
      to: "src/asset_optimization/models/base.py"
      via: "inherits DeteriorationModel"
      pattern: "class ProportionalHazardsModel\\(DeteriorationModel\\)"
    - from: "src/asset_optimization/models/proportional_hazards.py"
      to: "baseline model"
      via: "delegates params/type_column/age_column"
      pattern: "self\\.baseline\\.(params|type_column|age_column)"
---

<objective>
Create ProportionalHazardsModel that wraps any baseline DeteriorationModel and scales hazard rates by exp(beta'x) based on covariate values.

Purpose: Enable covariate-based failure rate modeling where asset properties beyond age/type affect failure probability (HAZD-01 through HAZD-05).

Output: Working ProportionalHazardsModel class with full test coverage.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-proportional-hazards/07-RESEARCH.md

# Key source files to reference
@src/asset_optimization/models/base.py
@src/asset_optimization/models/weibull.py
@tests/test_deterioration.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProportionalHazardsModel class</name>
  <files>
    src/asset_optimization/models/proportional_hazards.py
    src/asset_optimization/models/__init__.py
  </files>
  <action>
Create `src/asset_optimization/models/proportional_hazards.py` with:

1. **Class definition** inheriting from DeteriorationModel:
```python
class ProportionalHazardsModel(DeteriorationModel):
    """Proportional hazards wrapper around any baseline DeteriorationModel.

    h(t|x) = h_baseline(t) * exp(sum(beta_i * x_i))
    """
```

2. **__init__ method** accepting:
   - `baseline: DeteriorationModel` - the wrapped model
   - `covariates: list[str]` - column names to use as covariates
   - `coefficients: dict[str, float]` - maps covariate name to beta coefficient
   - Validate that all covariates have corresponding coefficients

3. **Property delegation** to baseline model:
   - `params` property -> `self.baseline.params`
   - `type_column` property -> `self.baseline.type_column`
   - `age_column` property -> `self.baseline.age_column`

4. **_risk_score(df) method** computing exp(beta'x):
   - Build linear predictor: `sum(beta_i * x_i)` for each row
   - Handle missing columns: if covariate column absent, treat all rows as baseline-only (return 1.0)
   - Handle NaN values: rows with NaN in any covariate get risk_score=1.0
   - Clip linear predictor to [-500, 500] before exp() to prevent overflow
   - Return numpy array of risk scores

5. **failure_rate(age, **kwargs) method**:
   - Delegate to baseline.failure_rate()
   - Note: scaling by risk_score happens in transform(), not here (matches WeibullModel pattern)

6. **transform(df) method**:
   - Call baseline.transform(df) to get failure_rate and failure_probability
   - Compute risk scores via _risk_score()
   - Scale failure_rate: `result['failure_rate'] *= risk`
   - Scale failure_probability using exact Weibull-PH formula:
     - `survival_baseline = 1.0 - result['failure_probability']`
     - `result['failure_probability'] = 1.0 - np.power(survival_baseline, risk)`
   - Return result

7. **__repr__ method** showing baseline type and covariate count

Update `src/asset_optimization/models/__init__.py`:
- Import ProportionalHazardsModel
- Add to __all__ list
  </action>
  <verify>
```bash
cd /Users/henkgriffioen/code/asset-optimization
python -c "from asset_optimization.models import ProportionalHazardsModel; print('Import OK')"
```
  </verify>
  <done>
ProportionalHazardsModel class exists and is importable from asset_optimization.models
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive test suite</name>
  <files>tests/test_proportional_hazards.py</files>
  <action>
Create `tests/test_proportional_hazards.py` following the pattern in test_deterioration.py:

**TestProportionalHazardsModelInit class:**
- `test_instantiation_with_valid_params` - model creates with baseline, covariates, coefficients
- `test_covariates_must_match_coefficients` - ValueError if mismatch
- `test_empty_covariates_allowed` - empty list is valid (becomes baseline-only wrapper)
- `test_repr` - repr shows baseline type and covariate info

**TestProportionalHazardsModelDelegation class:**
- `test_params_delegates_to_baseline` - model.params returns baseline.params
- `test_type_column_delegates_to_baseline` - model.type_column returns baseline.type_column
- `test_age_column_delegates_to_baseline` - model.age_column returns baseline.age_column

**TestProportionalHazardsModelTransform class:**
- `test_transform_adds_columns` - returns df with failure_rate, failure_probability
- `test_transform_returns_copy` - original df unchanged
- `test_transform_preserves_original_columns` - all input columns preserved
- `test_transform_increases_failure_rate_with_positive_covariate` - positive beta * positive x increases rate
- `test_transform_decreases_failure_rate_with_negative_coefficient` - negative beta decreases rate

**TestProportionalHazardsModelBackwardCompat class (HAZD-05):**
- `test_missing_covariate_column_uses_baseline_only` - if covariate column absent, risk_score=1.0
- `test_nan_covariate_uses_baseline_for_that_row` - NaN in covariate -> baseline for that row only
- `test_partial_nan_handles_correctly` - some rows NaN, others not

**TestProportionalHazardsModelMathematical class:**
- `test_risk_score_exp_of_linear_combination` - verify exp(beta'x) formula
- `test_failure_probability_uses_survival_power_formula` - verify F(t|x) = 1 - S0(t)^r
- `test_zero_covariates_equals_baseline` - empty covariates list gives identical results to baseline
- `test_overflow_protection` - large beta*x values don't produce inf

**Fixtures needed in test file:**
- `weibull_baseline` - WeibullModel with standard params
- `ph_model` - ProportionalHazardsModel wrapping weibull_baseline
- `df_with_covariates` - DataFrame including covariate columns
- `df_without_covariates` - DataFrame missing covariate columns
  </action>
  <verify>
```bash
cd /Users/henkgriffioen/code/asset-optimization
pytest tests/test_proportional_hazards.py -v
```
  </verify>
  <done>
All tests pass. Test coverage includes initialization, delegation, transform behavior, backward compatibility, and mathematical correctness.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/henkgriffioen/code/asset-optimization

# All tests pass
pytest tests/test_proportional_hazards.py -v

# Import works from public API
python -c "from asset_optimization.models import ProportionalHazardsModel, WeibullModel; print('OK')"

# Quick smoke test
python -c "
from asset_optimization.models import ProportionalHazardsModel, WeibullModel
import pandas as pd

baseline = WeibullModel({'PVC': (2.5, 50)})
ph = ProportionalHazardsModel(baseline, covariates=['diameter_mm'], coefficients={'diameter_mm': 0.01})

df = pd.DataFrame({'material': ['PVC', 'PVC'], 'age': [20, 20], 'diameter_mm': [100, 200]})
result = ph.transform(df)

# Larger diameter should have higher failure rate
assert result.iloc[1]['failure_rate'] > result.iloc[0]['failure_rate'], 'Covariate effect works'
print('Smoke test passed')
"
```
</verification>

<success_criteria>
- ProportionalHazardsModel class exists in models/proportional_hazards.py
- Class inherits from DeteriorationModel
- Delegates params, type_column, age_column to baseline
- transform() scales failure_rate by exp(beta'x)
- Missing covariate columns handled gracefully (baseline-only)
- NaN values handled gracefully (baseline for affected rows)
- All tests in test_proportional_hazards.py pass
- Import available from asset_optimization.models
</success_criteria>

<output>
After completion, create `.planning/phases/07-proportional-hazards/07-01-SUMMARY.md`
</output>
