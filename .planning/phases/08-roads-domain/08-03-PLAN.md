---
phase: 08-roads-domain
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - notebooks/05_roads_domain.py
  - notebooks/05_roads_domain.ipynb
autonomous: true

must_haves:
  truths:
    - "Notebook demonstrates creating a RoadDomain and using validate, default_interventions, default_model"
    - "Notebook shows road portfolio creation with surface_type, traffic_load, climate_zone columns"
    - "Notebook runs simulation with road-specific deterioration model and interventions"
    - "Notebook compares different surface types or intervention strategies"
    - "Notebook executes without error via `make docs`"
  artifacts:
    - path: "notebooks/05_roads_domain.py"
      provides: "Jupytext percent-format source for road domain documentation"
    - path: "notebooks/05_roads_domain.ipynb"
      provides: "Synced notebook output for human consumption"
  key_links:
    - from: "notebooks/05_roads_domain.py"
      to: "src/asset_optimization/domains/roads.py"
      via: "imports RoadDomain"
      pattern: "from asset_optimization import RoadDomain"
    - from: "notebooks/05_roads_domain.py"
      to: "src/asset_optimization/simulation/simulator.py"
      via: "runs Simulator with road model and interventions"
      pattern: "Simulator"
---

<objective>
Create a documentation notebook demonstrating road domain configuration and simulation.

Purpose: Fulfills DOCS-02 requirement. Shows users how to use RoadDomain for road asset portfolio management end-to-end.
Output: Jupytext .py source and synced .ipynb notebook.
</objective>

<execution_context>
@/Users/henkgriffioen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henkgriffioen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-roads-domain/08-CONTEXT.md
@.planning/phases/08-roads-domain/08-01-SUMMARY.md
@.planning/phases/08-roads-domain/08-02-SUMMARY.md
@notebooks/TEMPLATE.py
@notebooks/01_quickstart.py
@src/asset_optimization/domains/roads.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create road domain documentation notebook</name>
  <files>
    notebooks/05_roads_domain.py
  </files>
  <action>
Create `notebooks/05_roads_domain.py` in Jupytext percent format, following the style of existing notebooks (see `notebooks/TEMPLATE.py` and `notebooks/01_quickstart.py` for format).

**Notebook structure:**

1. **Title cell** (markdown): "Road Domain Configuration and Simulation"
   - Brief intro: using RoadDomain for road asset portfolios

2. **Setup cell** (code): imports
   ```python
   import pandas as pd
   import numpy as np
   import matplotlib.pyplot as plt
   from asset_optimization import (
       RoadDomain, Simulator, SimulationConfig,
       set_sdk_theme, plot_cost_over_time, plot_failures_by_year,
   )
   set_sdk_theme()
   ```

3. **Domain overview** (markdown): explain RoadDomain provides schema validation, default interventions, and a default deterioration model

4. **Create domain and explore defaults** (code):
   - `domain = RoadDomain()`
   - Show default interventions for asphalt, concrete, gravel
   - Show default model configuration

5. **Create road portfolio** (markdown + code):
   - Create a sample DataFrame with ~20-30 road segments
   - Mix of surface types (asphalt, concrete, gravel)
   - Mix of traffic loads and climate zones
   - Realistic install dates spanning 5-30 years ago
   - Validate with `domain.validate(df)`

6. **Encode covariates** (code):
   - Use `RoadDomain.encode_covariates(df)` to add numeric columns
   - Show the encoded DataFrame

7. **Run simulation** (markdown + code):
   - Get default model and interventions
   - Create SimulationConfig (10 years, seed=42)
   - **IMPORTANT:** The Simulator currently validates using the pipe portfolio schema. Add `asset_type="road"` and `material=surface_type` columns before running the simulation (keep `surface_type` for the RoadDomain model). This avoids validation errors and fills the failure log `material` field.
   - **IMPORTANT:** Pass the encoded DataFrame (from step 6, with `traffic_load_encoded` and `climate_zone_encoded` columns) to the Simulator — the ProportionalHazardsModel requires these numeric covariate columns
   - Create Simulator with road model and road interventions
   - Run simulation, show summary

8. **Visualize results** (code):
   - Plot cost over time
   - Plot failures by year

9. **Compare surface types** (markdown + code):
   - Create two portfolios: all-asphalt vs all-gravel
   - Run both through simulator
   - Compare total costs to show gravel deteriorates faster

10. **Cleanup cell** (code): `plt.close("all")`

Use `# %%` for code cells and `# %% [markdown]` for markdown cells with triple-quoted content.
Add `# ruff: noqa: E402` after the jupytext header if needed.

Keep the tone tutorial-style, concise, and practical. Show output where useful.
  </action>
  <verify>
    `MPLBACKEND=Agg uv run python notebooks/05_roads_domain.py` — executes without error
  </verify>
  <done>
    Road domain notebook source created in percent format and executes cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync notebook and verify full pipeline</name>
  <files>
    notebooks/05_roads_domain.ipynb
  </files>
  <action>
1. Run `make docs-sync` to generate the .ipynb from the .py source
2. Verify the .ipynb file exists and has cells
3. Run `make docs` to execute and re-sync all notebooks (ensures no regressions)
4. Run `make lint` and `make test` to ensure everything is clean
  </action>
  <verify>
    `make docs` — all notebooks execute and sync without error
    `make lint` — clean
    `make test` — all tests pass
  </verify>
  <done>
    Notebook synced to .ipynb. All quality gates pass (lint, test, docs).
  </done>
</task>

</tasks>

<verification>
1. `MPLBACKEND=Agg uv run python notebooks/05_roads_domain.py` — notebook runs
2. `make docs` — all notebooks execute and sync
3. `make lint` — clean
4. `make test` — all tests pass
5. `ls notebooks/05_roads_domain.ipynb` — synced notebook exists
</verification>

<success_criteria>
- Road domain notebook demonstrates full workflow: domain creation, portfolio validation, simulation, visualization
- Notebook executes without error
- .ipynb synced via jupytext
- All quality gates pass (lint, test, docs)
</success_criteria>

<output>
After completion, create `.planning/phases/08-roads-domain/08-03-SUMMARY.md`
</output>
