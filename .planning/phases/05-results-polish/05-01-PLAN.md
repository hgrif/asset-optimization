---
phase: 05-results-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/asset_optimization/exports.py
  - src/asset_optimization/simulation/result.py
  - src/asset_optimization/optimization/result.py
  - src/asset_optimization/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can export optimization selections to minimal parquet (asset_id, year, intervention_type, cost)"
    - "User can export optimization selections to detailed parquet (adds risk_score, rank, material, age, risk_before, risk_after, risk_reduction)"
    - "User can export simulation summary to parquet with cost projections by year"
    - "User can export expected failure metrics by year (OUTP-03)"
    - "Export follows pandas pattern: result.to_parquet('path')"
  artifacts:
    - path: "src/asset_optimization/exports.py"
      provides: "Export functions for parquet format"
      exports: ["export_schedule_minimal", "export_schedule_detailed", "export_cost_projections"]
    - path: "pyproject.toml"
      provides: "Dependencies for parquet and visualization"
      contains: "pyarrow"
  key_links:
    - from: "src/asset_optimization/simulation/result.py"
      to: "src/asset_optimization/exports.py"
      via: "to_parquet method calling export functions"
      pattern: "to_parquet"
    - from: "src/asset_optimization/optimization/result.py"
      to: "src/asset_optimization/exports.py"
      via: "to_parquet method calling export functions"
      pattern: "to_parquet"
---

<objective>
Add parquet export capabilities to SimulationResult and OptimizationResult classes

Purpose: Enable users to export intervention schedules and cost projections to parquet format (OUTP-01, OUTP-02, OUTP-03, OUTP-05)
Output: exports.py module with export functions, to_parquet methods on result classes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-results-polish/05-CONTEXT.md

@src/asset_optimization/simulation/result.py
@src/asset_optimization/optimization/result.py
@src/asset_optimization/__init__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies and create exports module</name>
  <files>
    pyproject.toml
    src/asset_optimization/exports.py
  </files>
  <action>
1. Update pyproject.toml to add pyarrow and seaborn dependencies:
   - Add "pyarrow>=14.0.0" to dependencies list (for parquet support)
   - Add "seaborn>=0.13.0" to dependencies list (needed for Plan 03)
   - Add "matplotlib>=3.7.0" to dependencies list (seaborn dependency)

2. Create src/asset_optimization/exports.py with these functions:

```python
"""Export utilities for parquet format."""

from pathlib import Path
from typing import Union

import pandas as pd


def export_schedule_minimal(
    selections: pd.DataFrame,
    path: Union[str, Path],
    year: int = 2024,
) -> None:
    """Export intervention schedule in minimal format.

    Parameters
    ----------
    selections : pd.DataFrame
        Selections DataFrame from OptimizationResult with columns:
        asset_id, intervention_type, cost, risk_score, rank
    path : str or Path
        Output path for parquet file
    year : int, default 2024
        Year for the intervention schedule

    Notes
    -----
    Minimal format columns: asset_id, year, intervention_type, cost
    """
    minimal = pd.DataFrame({
        'asset_id': selections['asset_id'],
        'year': year,
        'intervention_type': selections['intervention_type'],
        'cost': selections['cost'],
    })
    minimal.to_parquet(path, index=False)


def export_schedule_detailed(
    selections: pd.DataFrame,
    path: Union[str, Path],
    year: int = 2024,
    portfolio: pd.DataFrame = None,
) -> None:
    """Export intervention schedule in detailed format.

    Parameters
    ----------
    selections : pd.DataFrame
        Selections DataFrame from OptimizationResult
    path : str or Path
        Output path for parquet file
    year : int, default 2024
        Year for the intervention schedule
    portfolio : pd.DataFrame, optional
        Portfolio DataFrame to join for material and age columns.
        If None, material and age columns will be omitted.

    Notes
    -----
    Detailed format columns: asset_id, year, intervention_type, cost,
    risk_score, rank, material, age, risk_before, risk_after, risk_reduction

    risk_before and risk_after must be present in selections DataFrame
    (added by Optimizer during fit). risk_reduction is computed as difference.
    """
    detailed = selections[['asset_id', 'intervention_type', 'cost', 'risk_score', 'rank']].copy()
    detailed['year'] = year

    # Add risk columns if present
    if 'risk_before' in selections.columns:
        detailed['risk_before'] = selections['risk_before']
    if 'risk_after' in selections.columns:
        detailed['risk_after'] = selections['risk_after']
    if 'risk_before' in selections.columns and 'risk_after' in selections.columns:
        detailed['risk_reduction'] = selections['risk_before'] - selections['risk_after']

    # Join portfolio for material and age if provided
    if portfolio is not None:
        portfolio_cols = portfolio[['asset_id']].copy()
        if 'material' in portfolio.columns:
            portfolio_cols['material'] = portfolio['material']
        elif 'asset_type' in portfolio.columns:
            portfolio_cols['material'] = portfolio['asset_type']
        if 'age' in portfolio.columns:
            portfolio_cols['age'] = portfolio['age']
        detailed = detailed.merge(portfolio_cols, on='asset_id', how='left')

    # Reorder columns for consistency
    col_order = ['asset_id', 'year', 'intervention_type', 'cost', 'risk_score', 'rank']
    optional_cols = ['material', 'age', 'risk_before', 'risk_after', 'risk_reduction']
    for col in optional_cols:
        if col in detailed.columns:
            col_order.append(col)
    detailed = detailed[col_order]

    detailed.to_parquet(path, index=False)


def export_cost_projections(
    summary: pd.DataFrame,
    path: Union[str, Path],
) -> None:
    """Export cost projections by year in long format.

    Parameters
    ----------
    summary : pd.DataFrame
        Summary DataFrame from SimulationResult with columns:
        year, total_cost, failure_count, intervention_count, avg_age
    path : str or Path
        Output path for parquet file

    Notes
    -----
    Output is in long format with columns: year, metric, value
    This format is easier for plotting with seaborn/matplotlib.
    Includes failure_count metric (OUTP-03: expected failure metrics by year).
    """
    # Melt to long format
    metrics = ['total_cost', 'failure_count', 'intervention_count', 'avg_age']
    available_metrics = [m for m in metrics if m in summary.columns]

    long_df = summary.melt(
        id_vars=['year'],
        value_vars=available_metrics,
        var_name='metric',
        value_name='value',
    )
    long_df.to_parquet(path, index=False)
```

Use NumPy-style docstrings as specified in CONTEXT.md.
  </action>
  <verify>
    python -c "from asset_optimization.exports import export_schedule_minimal, export_schedule_detailed, export_cost_projections; print('Imports OK')"
  </verify>
  <done>
    - pyproject.toml has pyarrow>=14.0.0, seaborn>=0.13.0, matplotlib>=3.7.0
    - exports.py exists with 3 export functions
    - Functions have NumPy-style docstrings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add to_parquet methods to result classes</name>
  <files>
    src/asset_optimization/simulation/result.py
    src/asset_optimization/optimization/result.py
    src/asset_optimization/__init__.py
  </files>
  <action>
1. Add to_parquet method to SimulationResult in src/asset_optimization/simulation/result.py:

```python
def to_parquet(self, path: Union[str, Path], format: str = 'summary') -> None:
    """Export simulation results to parquet.

    Parameters
    ----------
    path : str or Path
        Output path for parquet file
    format : str, default 'summary'
        Export format:
        - 'summary': Year-by-year summary with cost, failures, interventions
        - 'cost_projections': Long format for plotting (year, metric, value)
        - 'failure_log': Detailed failure event log

    Raises
    ------
    ValueError
        If format is not one of the supported options.

    Examples
    --------
    >>> result.to_parquet('simulation_summary.parquet')
    >>> result.to_parquet('projections.parquet', format='cost_projections')
    """
    from asset_optimization.exports import export_cost_projections

    if format == 'summary':
        self.summary.to_parquet(path, index=False)
    elif format == 'cost_projections':
        export_cost_projections(self.summary, path)
    elif format == 'failure_log':
        self.failure_log.to_parquet(path, index=False)
    else:
        raise ValueError(f"Unknown format: {format}. Use 'summary', 'cost_projections', or 'failure_log'")
```

Add necessary imports at top: `from pathlib import Path` and `from typing import Union` (if not already present).

2. Add to_parquet method to OptimizationResult in src/asset_optimization/optimization/result.py:

```python
def to_parquet(
    self,
    path: Union[str, Path],
    format: str = 'minimal',
    year: int = 2024,
    portfolio: Optional[pd.DataFrame] = None,
) -> None:
    """Export optimization results to parquet.

    Parameters
    ----------
    path : str or Path
        Output path for parquet file
    format : str, default 'minimal'
        Export format:
        - 'minimal': asset_id, year, intervention_type, cost
        - 'detailed': adds risk_score, rank, material, age, risk columns
    year : int, default 2024
        Year to associate with interventions
    portfolio : pd.DataFrame, optional
        Portfolio DataFrame for detailed format (provides material, age columns)

    Raises
    ------
    ValueError
        If format is not 'minimal' or 'detailed'.

    Examples
    --------
    >>> result.to_parquet('schedule.parquet')
    >>> result.to_parquet('schedule_detailed.parquet', format='detailed', portfolio=portfolio.data)
    """
    from asset_optimization.exports import export_schedule_minimal, export_schedule_detailed

    if format == 'minimal':
        export_schedule_minimal(self.selections, path, year=year)
    elif format == 'detailed':
        export_schedule_detailed(self.selections, path, year=year, portfolio=portfolio)
    else:
        raise ValueError(f"Unknown format: {format}. Use 'minimal' or 'detailed'")
```

Add necessary imports at top of optimization/result.py:
- `from pathlib import Path`
- `from typing import Optional, Union`

NOTE: Union and Optional are NOT currently imported in optimization/result.py - they must be added.

3. Update src/asset_optimization/__init__.py to export the export functions:
   - Add to imports: `from .exports import export_schedule_minimal, export_schedule_detailed, export_cost_projections`
   - Add to __all__: "export_schedule_minimal", "export_schedule_detailed", "export_cost_projections"
  </action>
  <verify>
    python -c "
from asset_optimization import SimulationResult, OptimizationResult
import pandas as pd
# Verify methods exist
assert hasattr(SimulationResult, 'to_parquet'), 'SimulationResult missing to_parquet'
assert hasattr(OptimizationResult, 'to_parquet'), 'OptimizationResult missing to_parquet'
print('Methods exist')

# Verify exports
from asset_optimization import export_schedule_minimal, export_schedule_detailed, export_cost_projections
print('Top-level exports OK')
"
  </verify>
  <done>
    - SimulationResult has to_parquet(path, format='summary'|'cost_projections'|'failure_log')
    - OptimizationResult has to_parquet(path, format='minimal'|'detailed', year, portfolio)
    - Export functions available from top-level package
  </done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies and verify exports work</name>
  <action>
1. Install updated dependencies:
   cd /Users/henkgriffioen/code/asset-optimization && pip install -e ".[dev]"

2. Create a quick integration test to verify exports work:

```python
import tempfile
from pathlib import Path
import pandas as pd
from asset_optimization import SimulationResult, OptimizationResult
from asset_optimization.simulation import SimulationConfig

# Test SimulationResult export
config = SimulationConfig(n_years=3)
summary = pd.DataFrame({
    'year': [2024, 2025, 2026],
    'total_cost': [100000.0, 120000.0, 110000.0],
    'failure_count': [5, 7, 6],
    'intervention_count': [10, 12, 11],
    'avg_age': [25.0, 26.0, 27.0],
})
sim_result = SimulationResult(
    summary=summary,
    cost_breakdown=pd.DataFrame(),
    failure_log=pd.DataFrame(),
    config=config,
)

with tempfile.TemporaryDirectory() as tmpdir:
    # Test summary export
    sim_result.to_parquet(Path(tmpdir) / 'summary.parquet', format='summary')
    df = pd.read_parquet(Path(tmpdir) / 'summary.parquet')
    assert len(df) == 3, f"Expected 3 rows, got {len(df)}"

    # Test cost projections export (includes failure_count for OUTP-03)
    sim_result.to_parquet(Path(tmpdir) / 'projections.parquet', format='cost_projections')
    df = pd.read_parquet(Path(tmpdir) / 'projections.parquet')
    assert 'metric' in df.columns, "Missing metric column"
    assert 'value' in df.columns, "Missing value column"
    assert 'failure_count' in df['metric'].values, "Missing failure_count metric (OUTP-03)"

# Test OptimizationResult export
selections = pd.DataFrame({
    'asset_id': ['A1', 'A2', 'A3'],
    'intervention_type': ['Replace', 'Repair', 'Inspect'],
    'cost': [5000.0, 1000.0, 200.0],
    'risk_score': [0.8, 0.5, 0.2],
    'rank': [1, 2, 3],
    'risk_before': [0.8, 0.5, 0.2],
    'risk_after': [0.0, 0.3, 0.15],
})
budget_summary = pd.DataFrame({
    'budget': [10000.0],
    'spent': [6200.0],
    'remaining': [3800.0],
    'utilization_pct': [62.0],
})
opt_result = OptimizationResult(
    selections=selections,
    budget_summary=budget_summary,
    strategy='greedy',
)

with tempfile.TemporaryDirectory() as tmpdir:
    # Test minimal export
    opt_result.to_parquet(Path(tmpdir) / 'minimal.parquet', format='minimal', year=2024)
    df = pd.read_parquet(Path(tmpdir) / 'minimal.parquet')
    assert list(df.columns) == ['asset_id', 'year', 'intervention_type', 'cost'], f"Wrong columns: {list(df.columns)}"

    # Test detailed export
    opt_result.to_parquet(Path(tmpdir) / 'detailed.parquet', format='detailed', year=2024)
    df = pd.read_parquet(Path(tmpdir) / 'detailed.parquet')
    assert 'risk_reduction' in df.columns, "Missing risk_reduction column"

print("All export tests passed!")
```

Run this verification script.
  </action>
  <verify>
    python -c "import pandas as pd; pd.DataFrame({'a': [1]}).to_parquet('/tmp/test.parquet'); print('Parquet support OK')"
  </verify>
  <done>
    - Dependencies installed (pyarrow working)
    - SimulationResult.to_parquet works for all 3 formats
    - OptimizationResult.to_parquet works for minimal and detailed formats
    - Long format cost projections suitable for plotting
    - failure_count metric exported (OUTP-03)
  </done>
</task>

</tasks>

<verification>
1. `pip install -e ".[dev]"` succeeds
2. `python -c "from asset_optimization import export_schedule_minimal; print('OK')"` works
3. Parquet files can be written and read back
4. Cost projections are in long format (year, metric, value)
5. failure_count metric is included in cost projections export (OUTP-03)
</verification>

<success_criteria>
- OUTP-05 (export to parquet): SimulationResult and OptimizationResult have to_parquet methods
- OUTP-01 (intervention schedule): export_schedule_minimal produces asset_id, year, intervention_type, cost
- OUTP-02 (cost projection): export_cost_projections produces long-format year/metric/value
- OUTP-03 (failure metrics by year): failure_count included in cost_projections export
- All exports follow pandas pattern: result.to_parquet('path')
</success_criteria>

<output>
After completion, create `.planning/phases/05-results-polish/05-01-SUMMARY.md`
</output>
