---
phase: 06-asset-traceability
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/asset_optimization/simulation/config.py
  - src/asset_optimization/simulation/result.py
  - src/asset_optimization/simulation/simulator.py
  - src/asset_optimization/exports.py
  - tests/test_simulation.py
  - tests/test_exports.py
autonomous: true

must_haves:
  truths:
    - "SimulationResult returns asset-level history by default with per-year action, failure flag, costs, and age"
    - "Asset history schema is stable and documented"
    - "SimulationConfig defaults to tracking asset history (opt-out allowed)"
  artifacts:
    - path: "src/asset_optimization/simulation/result.py"
      provides: "SimulationResult asset_history field and parquet export"
    - path: "src/asset_optimization/simulation/simulator.py"
      provides: "Asset history construction in simulation loop"
    - path: "tests/test_simulation.py"
      provides: "Asset history assertions"
  key_links:
    - from: "src/asset_optimization/simulation/simulator.py"
      to: "src/asset_optimization/simulation/result.py"
      via: "asset_history field"
      pattern: "asset_history"
---

<objective>
Add asset-level event tracking to simulations and return it by default, enabling downstream analysis and visualization of actions, failures, costs, and asset age.

Purpose: make simulation behavior transparent and provide a per-asset timeline for debugging and reporting.
Output: asset_history DataFrame on SimulationResult, default tracking in config, tests updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-asset-traceability/06-CONTEXT.md

# Current implementation
@src/asset_optimization/simulation/config.py
@src/asset_optimization/simulation/result.py
@src/asset_optimization/simulation/simulator.py
@tests/test_simulation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define asset history schema and default tracking</name>
  <files>
    src/asset_optimization/simulation/config.py
    src/asset_optimization/simulation/result.py
  </files>
  <action>
1. Update SimulationConfig:
   - Default `track_asset_history` to True (or remove the flag if always-on).
   - Update docstrings to describe default behavior and memory considerations.

2. Update SimulationResult:
   - Make `asset_history` non-optional if always-on, or document when it is None if disabled.
   - Document schema with columns: year, asset_id, age, action, failed, failure_cost, intervention_cost, total_cost.
   - Add `to_parquet(..., format='asset_history')` if exporting is needed.
  </action>
  <verify>
    python -c "from asset_optimization.simulation import SimulationConfig; assert SimulationConfig(n_years=1).track_asset_history is True"
  </verify>
  <done>
    - asset_history schema documented
    - tracking is default-on
  </done>
</task>

<task type="auto">
  <name>Task 2: Capture per-asset actions, failures, and costs</name>
  <files>
    src/asset_optimization/simulation/simulator.py
  </files>
  <action>
1. Extend _simulate_timestep to return per-asset action/costs (or compute in run loop):
   - action: one of none, record_only, repair, replace
   - failed: boolean
   - failure_cost: direct + consequence cost per failed asset
   - intervention_cost: cost applied when repair/replace
   - total_cost: failure_cost + intervention_cost

2. In Simulator.run, build asset_history rows for each asset-year with the above fields plus age.
3. Ensure action reflects what happened in that year (e.g., replace when failure_response='replace').
4. Keep failure_log behavior intact, but ensure it is consistent with asset_history.
  </action>
  <verify>
    uv run pytest tests/test_simulation.py -q
  </verify>
  <done>
    - asset_history contains one row per asset per year
    - action/failed/costs populated with deterministic logic
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tests for asset history and optional export</name>
  <files>
    tests/test_simulation.py
    tests/test_exports.py
    src/asset_optimization/exports.py
  </files>
  <action>
1. Add simulation tests asserting:
   - asset_history is present by default
   - required columns exist
   - action values are valid
2. If adding a parquet export for asset_history, add tests in test_exports.py.
  </action>
  <verify>
    uv run pytest tests/test_simulation.py -q
  </verify>
  <done>
    - tests cover asset_history schema
    - exports (if added) are verified
  </done>
</task>

</tasks>
